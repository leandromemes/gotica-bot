/**
 * Comando !tirardinheiro - Vers√£o Corrigida com Checagem de Dono e JID
 * Remove dinheiro do saldo de um membro.
 */
const fs = require("fs");
const path = require("path");
const { PREFIX } = require(`${BASE_DIR}/config`);

const SALDO_FILE = "saldo-real"; 
const MIN_FRACTION_DIGITS = 0; // Usaremos 0, j√° que o resto do sistema usa.

// JIDs FIXOS PARA O DONO (CORRE√á√ÉO DE CHAVE MESTRA)
const TARGET_JID_DONO = '240041947357401@lid'; 
const DONO_PHONE = '556391330669@s.whatsapp.net';

// FUN√á√ïES DE MANIPULA√á√ÉO DE ARQUIVO
function getPaths() {
  const databaseDir = path.resolve(`${BASE_DIR}/database`);
  if (!fs.existsSync(databaseDir)) {
    fs.mkdirSync(databaseDir, { recursive: true });
  }
  const saldoPath = path.resolve(`${databaseDir}/${SALDO_FILE}.json`);
  if (!fs.existsSync(saldoPath)) fs.writeFileSync(saldoPath, JSON.stringify({}));
  return { saldoPath };
}

// FUN√á√ÉO MODIFICADA PARA SUBTRAIR
function updateRealSaldo(key, amount) {
    const { saldoPath } = getPaths(); 
    let saldoData = JSON.parse(fs.readFileSync(saldoPath, 'utf8'));

    if (!saldoData[key]) {
        saldoData[key] = 0;
    }
    
    // VERIFICA SE O VALOR A REMOVER √â MAIOR QUE O SALDO, E ZERA SE FOR.
    if (saldoData[key] < amount) {
        saldoData[key] = 0;
    } else {
        saldoData[key] -= amount; // SUBTRA√á√ÉO
    }
    
    fs.writeFileSync(saldoPath, JSON.stringify(saldoData, null, 2));
    
    return { balance: saldoData[key] };
}
// -----------------------------------------------------------

const formatarReal = (valor) => 
  new Intl.NumberFormat("pt-BR", { 
    style: 'currency', 
    currency: 'BRL',
    minimumFractionDigits: MIN_FRACTION_DIGITS 
  }).format(valor);


module.exports = {
  name: "tirardinheiro",
  commands: ["tirardinheiro", "removerbot", "removergrana"],
  usage: `${PREFIX}tirardinheiro valor (mencione ou responda)`,
  
  handle: async ({ remoteJid, userJid, args, isReply, replyJid, mentionedJidList, sendReply }) => {
    
    // CHECAGEM DE DONO (Obrigat√≥ria para este comando)
    const isOwner = userJid.includes(DONO_PHONE) || userJid.includes(TARGET_JID_DONO);
    
    if (!isOwner) {
        // Mensagem de erro para n√£o-Donos
        return sendReply(`‚ú® üö´ quem voc√™ pensa que √©? Esse comando √© s√≥ para meu dono *Leandro, aquele gostoso* üòéüî•`);
    }
    // ----------------------------------------------------------------------------------------
    
    let valorFloat = parseFloat(args[0]);
    let valor = Math.floor(Math.abs(valorFloat)); 

    if (isNaN(valor) || valor <= 0) {
      return sendReply(`‚ú® ‚ùå Valor inv√°lido. Use: ${PREFIX}tirardinheiro 100 @membro`);
    }

    let destinatarioJid = replyJid; 
    if (!destinatarioJid && mentionedJidList && mentionedJidList.length > 0) {
        destinatarioJid = mentionedJidList[0];
    }
    
    if (!destinatarioJid) {
        return sendReply(`‚ú® ‚ö†Ô∏è Voc√™ deve mencionar ou responder a mensagem da pessoa de quem deseja remover o dinheiro.`);
    }

    // Mapeamento de JID para o Destinat√°rio (checa se o destinat√°rio √© o Dono)
    let chaveDeDestino = destinatarioJid;
    if (destinatarioJid.includes(DONO_PHONE)) {
        chaveDeDestino = TARGET_JID_DONO; 
    }

    const destinatarioKey = `${remoteJid}-${chaveDeDestino}`;
    
    let valorFormatado = formatarReal(valor);

    // ESCREVE NA CHAVE CORRETA, SUBTRAINDO O VALOR
    const novoDados = updateRealSaldo(destinatarioKey, valor);
    
    const acao = novoDados.balance === 0 ? "ZERADO" : "REMOVIDO";

    await sendReply(
      `
‚ú® üëë *DINHEIRO ${acao} PELO DONO* üëë
---------------------------------
üí∏ Valor ${acao}: *${valorFormatado}*
üéØ Destinat√°rio: @${destinatarioJid.split('@')[0]}
üìâ Novo Saldo: ${formatarReal(novoDados.balance)}
---------------------------------
_(Comando ${PREFIX}tirardinheiro)_
    `.trim(),
      [destinatarioJid]
    );
  },
};