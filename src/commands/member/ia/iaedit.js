// src/commands/member/ia/iaedit.js

const { PREFIX } = require(`${BASE_DIR}/config`);
const { InvalidParameterError } = require(`${BASE_DIR}/errors`);

// O caminho de importa√ß√£o AGORA EST√Å CORRETO
const { editImageAI, spiderAPITokenConfigured } = require(`${BASE_DIR}/services/spider-x-api`);

// üö® CORRE√á√ÉO DE ERRO: Importando o downloadMediaMessage do Baileys
// O erro de 'MODULE_NOT_FOUND' sugere que este nome de m√≥dulo est√° errado no seu ambiente.
// Vamos tentar import√°-lo da forma que a maioria dos bots faz, se estiver dispon√≠vel no seu objeto 'webMessage'
// Para agora, vamos manter o require para que o erro de carregamento n√£o volte.
const { downloadMediaMessage } = require('@whiskeysockets/baileys'); 


module.exports = {
  name: "iaedit",
  description: "Edita uma imagem usando IA (Gemini/Spider X) com um prompt de texto.",
  commands: ["iaedit", "editaia"],
  usage: `${PREFIX}iaedit [responda √† imagem] adicione um chap√©u de cowboy`,
  
  /**
   * @param {CommandHandleProps} props
   * @returns {Promise<void>}
   */
  handle: async ({ fullArgs, sendReply, socket, webMessage }) => { 
    if (!spiderAPITokenConfigured) {
        return await sendReply("üö® A API do Spider X n√£o est√° configurada corretamente. Verifique seu token em `src/config.js`.");
    }
    
    const remoteJid = webMessage.key.remoteJid;
    // Tenta pegar a imagem da mensagem original ou da mensagem citada
    const media = webMessage.message?.imageMessage || webMessage.message?.extendedTextMessage?.contextInfo?.quotedMessage?.imageMessage;
    
    if (!media) {
      throw new InvalidParameterError(
        `Voc√™ precisa enviar ou responder a uma imagem e incluir o prompt de edi√ß√£o. Exemplo: ${PREFIX}iaedit [imagem] mude o fundo para um deserto`
      );
    }

    const prompt = fullArgs; 
    
    if (prompt.length < 5) {
        throw new InvalidParameterError(
            `Seu prompt √© muito curto. Descreva com mais detalhes o que voc√™ quer fazer na imagem.`
        );
    }

    await sendReply("‚è≥ Aguarde, estou enviando sua imagem para a IA e processando a edi√ß√£o. Isso pode levar um momento...");
    
    try {
        // 1. Baixar a imagem
        const buffer = await downloadMediaMessage(media, 'buffer');
        
        // 2. Converter para Base64
        const base64Image = buffer.toString('base64');

        // 3. Chamar a fun√ß√£o de edi√ß√£o (editImageAI)
        const imageUrl = await editImageAI(base64Image, prompt);

        // 4. Enviar a imagem editada de volta
        await socket.sendMessage(remoteJid, {
            image: { url: imageUrl },
            caption: `‚úÖ Sua imagem editada pela IA est√° pronta!\n*Prompt*: ${prompt}`,
            contextInfo: {}
        });

    } catch (e) {
        console.error("Erro no comando !iaedit:", e.message);
        await sendReply(`‚ùå Erro na Edi√ß√£o por IA: ${e.message}`);
    }
  },
};