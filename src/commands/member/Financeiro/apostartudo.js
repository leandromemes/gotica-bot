const { PREFIX } = require(`${BASE_DIR}/config`);
const fs = require("fs");
const path = require("path");
const { isActiveRealGroup } = require(`${BASE_DIR}/utils/database`);

// CORRE√á√ÉO 1: Nome do arquivo alinhado com o que funciona
const SALDO_FILE = "saldo-real";

// JIDs FIXOS PARA O DONO: Chave mestra do seu sistema de economia
const TARGET_JID_DONO = '240041947357401@lid'; 
const DONO_PHONE = '556391330669@s.whatsapp.net';

// Fun√ß√£o para formatar o saldo (consistente com os outros comandos)
const formatarReal = (valor) => 
  new Intl.NumberFormat("pt-BR", { 
    style: 'currency', 
    currency: 'BRL',
    minimumFractionDigits: 0 
  }).format(valor);

// Fun√ß√µes de Caminho (Unificada e Robusta)
function getPaths() {
  const databaseDir = path.resolve(`${BASE_DIR}/database`);

  if (!fs.existsSync(databaseDir)) {
    fs.mkdirSync(databaseDir, { recursive: true });
  }

  const saldoPath = path.resolve(`${databaseDir}/${SALDO_FILE}.json`);

  if (!fs.existsSync(saldoPath)) fs.writeFileSync(saldoPath, JSON.stringify({}));

  return { saldoPath };
}

function loadSaldoData() {
  const { saldoPath } = getPaths();
  const data = JSON.parse(fs.readFileSync(saldoPath));
  return { data, saldoPath };
}

module.exports = {
  name: "apostartudo",
  description: "Aposta todo seu saldo e pode dobrar ou perder tudo.",
  commands: ["apostartudo"],
  usage: `${PREFIX}apostartudo`,

  /**
   * @param {CommandHandleProps} props
   * @returns {Promise<void>}
   */
  handle: async ({ remoteJid, userJid, sendReply }) => {
    if (!isActiveRealGroup(remoteJid)) {
      return sendReply("‚ö†Ô∏è O modo real n√£o est√° ativado neste grupo.");
    }

    const { data, saldoPath } = loadSaldoData();
    
    // CORRE√á√ÉO 2: Mapeamento de JID para o Dono (Chave Mestra)
    let jidToUse = userJid;
    if (userJid.includes(DONO_PHONE)) {
        jidToUse = TARGET_JID_DONO; 
    }
    
    // A chave agora usa o JID mapeado para leitura/escrita
    const key = `${remoteJid}-${jidToUse}`;
    
    const saldoAtual = data[key] || 0;
    
    const saldoApostadoFormatado = formatarReal(saldoAtual);

    if (saldoAtual <= 0) {
      return sendReply("üò¢ Voc√™ n√£o tem saldo suficiente para apostar. Seu saldo √© R$0.");
    }

    // ü™ô Sorteio (50% chance)
    const ganhou = Math.random() < 0.5;

    // 1. L√≥gica de Ganhos/Perdas
    if (ganhou) {
      data[key] += saldoAtual; // dobra
    } else {
      data[key] = 0; // perde tudo
    }

    fs.writeFileSync(saldoPath, JSON.stringify(data, null, 2));
    
    const novoSaldoFormatado = formatarReal(data[key]);

    // 2. Frases sortidas
    const mensagensPerda = [
      `üíî Que trag√©dia! Voc√™ apostou *${saldoApostadoFormatado}* e perdeu tudo! Agora t√° zerado. üò¢`,
      `ü™ô Voc√™ foi com sede demais e perdeu seus *${saldoApostadoFormatado}*! O azar te pegou hoje. üíÄ`,
      `üòû Perdeu *${saldoApostadoFormatado}* no giro da sorte. A vida √© dura pra quem aposta alto. ü§ß`,
      `üîª Voc√™ se jogou no tudo ou nada e ficou com o nada. Saldo atual: *${novoSaldoFormatado}*. üò¨`,
      `üí∏ Apostou *${saldoApostadoFormatado}* e tomou no preju√≠zo! Vai ter que trabalhar de novo. üõ†Ô∏è`,
    ];

    const mensagensVitoria = [
      `üí∞ UAU! Voc√™ apostou *${saldoApostadoFormatado}* e DOBROU! Seu novo saldo √©: *${novoSaldoFormatado}*! üéâ`,
      `üèÜ Que jogada! Voc√™ apostou alto e saiu com o dobro! Novo saldo: *${novoSaldoFormatado}*! üí∏`,
      `üî• Incr√≠vel! Apostou tudo e ganhou! Seu saldo agora √©: *${novoSaldoFormatado}*! ü§ë`,
      `üçÄ Sorte grande! Sua aposta de *${saldoApostadoFormatado}* foi certeira! Novo saldo: *${novoSaldoFormatado}*!`,
      `üòé Apostou com coragem e se deu bem! Que virada sensacional! Novo saldo: *${novoSaldoFormatado}*!`,
    ];

    const msgArray = ganhou ? mensagensVitoria : mensagensPerda;
    const msg = msgArray[Math.floor(Math.random() * msgArray.length)];

    await sendReply(msg);
  },
};